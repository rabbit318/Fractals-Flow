<!DOCTYPE html>
<html>
<head>
    <title>Expert View</title>
    <link rel="stylesheet" href="/expertview-test/expert-view.css">
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/react-router-dom@6/umd/react-router-dom.production.min.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script>
        window.INTERNAL_REQUEST = true
    </script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { BrowserRouter, Routes, Route, useParams } = ReactRouterDOM;
        const { useState, useEffect } = React;
        
        const ThumbUpIcon = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path>
            </svg>
        );

        const ThumbDownIcon = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h3a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2h-3"></path>
            </svg>
        );

        const SimpleChatMessage = ({ chatflowid }) => {
            const [messages, setMessages] = useState([])
            const [input, setInput] = useState('')
            const [votes, setVotes] = useState({})
            
            const handleVote = async (messageIndex, vote) => {
                try {
                    // Toggle vote if clicking the same button
                    const newVote = votes[messageIndex] === vote ? null : vote;
                    
                    // Update local state immediately for UI feedback
                    setVotes(prev => ({
                        ...prev,
                        [messageIndex]: newVote
                    }));
                    
                    // Send vote to backend
                    await fetch(`/api/v1/chat/${chatflowid}/vote`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-request-from': 'internal'
                        },
                        body: JSON.stringify({
                            messageIndex,
                            vote: newVote
                        })
                    });
                } catch (error) {
                    console.error('Error submitting vote:', error);
                    // Revert vote on error
                    setVotes(prev => ({
                        ...prev,
                        [messageIndex]: votes[messageIndex]
                    }));
                }
            }
            
            const sendMessage = async () => {
                if (!input.trim()) return
                
                const userMessage = { type: 'user', message: input }
                setMessages(prev => [...prev, userMessage])
                setInput('')
                
                try {
                    const response = await fetch(`/api/v1/chat/${chatflowid}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-request-from': 'internal'
                        },
                        body: JSON.stringify({ question: input })
                    })
                    
                    const data = await response.json()
                    const botMessage = { type: 'bot', message: data.text }
                    setMessages(prev => [...prev, botMessage])
                } catch (error) {
                    console.error('Error sending message:', error)
                }
            }
            
            return (
                <div style={{ height: '100%', display: 'flex', flexDirection: 'column' }}>
                    
                    <div style={{ flex: 1, overflowY: 'auto', padding: '20px' }}>
                        {messages.map((msg, index) => (
                            <div key={index} className="message-container">
                                <div className={`message-bubble ${msg.type === 'user' ? 'user-message' : 'bot-message'}`}>
                                    {msg.message}
                                    {msg.type === 'bot' && (
                                        <div className="feedback-buttons">
                                            <button 
                                                onClick={() => handleVote(index, 'up')}
                                                className={`vote-button ${votes[index] === 'up' ? 'active' : ''}`}
                                            >
                                                <ThumbUpIcon />
                                            </button>
                                            <button 
                                                onClick={() => handleVote(index, 'down')}
                                                className={`vote-button ${votes[index] === 'down' ? 'active' : ''}`}
                                            >
                                                <ThumbDownIcon />
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>
                    
                    <div style={{
                        padding: '20px',
                        borderTop: '1px solid #e0e0e0',
                        display: 'flex',
                        gap: '10px'
                    }}>
                        <input
                            value={input}
                            onChange={(e) => setInput(e.target.value)}
                            onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
                            placeholder="Type your message..."
                            style={{
                                flex: 1,
                                padding: '15px',
                                borderRadius: '8px',
                                border: '1px solid #e0e0e0',
                                fontSize: '16px'
                            }}
                        />
                        <button
                            onClick={sendMessage}
                            style={{
                                padding: '15px',
                                backgroundColor: '#4987FC',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                width: '50px',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center'
                            }}
                        >
                            âž¤
                        </button>
                    </div>
                </div>
            )
        }

        const ExpertView = () => {
            const { chatflowid } = useParams()
            const [sources, setSources] = useState([])
            
            useEffect(() => {
                if (!chatflowid) return
                
                fetch(`/api/v1/chatflows/${chatflowid}/sources`, {
                    headers: {
                        'Content-Type': 'application/json',
                        'x-request-from': 'internal'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    setSources(data)
                })
            }, [chatflowid])

            if (!chatflowid) return null
            
            return (
                <div className="expert-container">
                    <div className="source-column">
                        <h2>Source Documents</h2>
                        <div className="source-list">
                            {sources.map((source, index) => (
                                <div key={index} className="source-item">
                                    <h3>{source.title}</h3>
                                    <p>{source.preview}</p>
                                </div>
                            ))}
                        </div>
                    </div>
                    <div className="chat-column">
                        <div style={{ 
                            display: 'flex',
                            flexDirection: 'column',
                            height: '100%',
                            background: 'white'
                        }}>
                            <div style={{
                                padding: '20px',
                                borderBottom: '1px solid #e0e0e0',
                                background: '#4987FC',
                                color: 'white'
                            }}>
                                <h2 style={{ margin: 0 }}>Hi there! How can I help?</h2>
                            </div>
                            
                            <div style={{
                                flex: 1,
                                overflowY: 'auto',
                                padding: '20px'
                            }}>
                                <SimpleChatMessage 
                                    chatflowid={chatflowid}
                                />
                            </div>
                        </div>
                    </div>
                </div>
            )
        }

        ReactDOM.createRoot(document.getElementById('root')).render(
            <BrowserRouter basename="/expertview">
                <Routes>
                    <Route path="/:chatflowid" element={<ExpertView />} />
                </Routes>
            </BrowserRouter>
        )
    </script>
</body>
</html>